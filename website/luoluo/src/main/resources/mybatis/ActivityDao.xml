<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE  mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.rpframework.website.luoluo.dao.IActivityDao">

	<resultMap type="com.rpframework.website.luoluo.domain.Activity" id="Activity" autoMapping="true">
		<id property="id" column="id" />
	</resultMap>		
	<select id="doPager" parameterType="map" resultMap="Activity">
		select * from release_activity where 1=1		
		<if test = "page.searchMap.calid != null">
			and activitycategory = #{page.searchMap.calid}
		</if>
		<if test = "page.searchMap.cityoles != null">
				and city = #{pager.getSearchMap.cityoles}
		</if>
		<if test = "page.searchMap.type != null">
			and type = #{page.searchMap.type}
		</if>
		<if test = "page.searchMap.typeok != null">
			and typeok = #{page.searchMap.typeok}
		</if>
		<if test = "page.searchMap.activiid != null">
			and sponsorid = #{page.searchMap.activiid}
		</if>
		<if test = "page.searchMap.ssid != null">
			and id = #{page.searchMap.ssid}
		</if>
		<if test = "page.searchMap.city != null">
			and city = #{page.searchMap.city}
		</if>
		<if test = "page.searchMap.name!= null">
			and activityname like '%${page.searchMap.name}%' 
			or activitynumber like '%${page.searchMap.name}%'  
		</if>
		<if test = "page.searchMap.se!= null">
			and typeok!=5 and typeok!=3  and typeok!=6
		</if>
		
		 order by id desc
			
	
	</select>
	<update id="update" parameterType="com.rpframework.website.luoluo.domain.Activity" />
	<insert id="insert" parameterType="com.rpframework.website.luoluo.domain.Activity" useGeneratedKeys="true" keyProperty="id"/>
	<delete id="delete" parameterType="com.rpframework.website.luoluo.domain.Activity" />
	<select id="select" parameterType="Integer" resultMap="Activity">
		select * from release_activity where id=#{activiid} order by id
	</select>
	<select id="doActivityList" resultMap="Activity">
		SELECT * FROM release_activity t1
		<!-- 按类型分类 1户外 2旅行 #{param1}-->
		WHERE t1.activitycategory = 2
		<!-- 开始时间1456615800  为今天 明天 后天 大于后天  #{param2}  #{param3}-->
		AND t1.starttime BETWEEN 1456610000 <!--#今天凌晨00：00-->
		                 AND 1456620000 <!-- 今天晚上23：59-->
		<!--活动天数-->
		AND (t1.outtime - t1.starttime) &lt; 86400*1 <!-- #{param4} 一天以内含一天 86400 = 1天-->
		<!--同城市 周边 省外 179  #{param5}-->
		AND t1.city IN <!--Not 长途活动 省外-->
			<!--(SELECT c.code FROM city c  WHERE c.codycity = 179) 同城-->
			<!--周边-->	
		(SELECT c.code FROM city c LEFT JOIN city cc ON cc.countryCode = c.countryCode WHERE c.codycity = 179) 
		<!--多妹子-->
		AND t1.Id IN 
		<!--报名表里sponsorid 报名 用户性别为女的 只是有妹子  #{param6} #{param7}-->
		(SELECT t2.sponsorld FROM activity_registration t2 WHERE t2.myld IN(
			SELECT t3.id FROM user t3 WHERE t3.sex = 1
		)) ORDER BY t1.starttime LIMIT 0,5
		<!-- 
			SELECT t2.sponsorld
				FROM activity_registration t2 WHERE t2.myld IN(
					SELECT t3.id FROM user t3 WHERE t3.sex = 1
				)
			GROUP BY t2.sponsorld ORDER BY COUNT(*) DESC LIMIT 1
		 -->
	</select>
	<!-- 为了提高用户访问量，有2个以上的妹子就是多妹子 查询妹子多的活动Id-->
	<select id="doActivityIdList" resultType="Integer">
			SELECT t2.sponsorld
				FROM activity_registration t2 WHERE t2.myld IN(
					SELECT t3.id FROM user t3 WHERE t3.sex = 1
				)
			GROUP BY t2.sponsorld having count(*)>=2
	</select>
	<select id="selectname" resultMap="Activity">
		select * from release_activity where activityname LIKE '%' #{name} '%' order by id
	</select>
	<select id="selectnumbers" resultMap="Activity">
		select * from release_activity where activitynumber LIKE '%' #{tole} '%' order by id
	</select>
	<select id="selectluist" resultMap="Activity">
		select * from release_activity where sponsorid=#{sponsorid} and typeok=6
	</select>
	<select id="selectactivice" parameterType="map" resultMap="Activity">
		SELECT *, ROUND(6378.138*2*ASIN(SQRT(POW(SIN((#{0}*PI()/180-lat*PI()/180)/2),2)+COS(#{0}*PI()/180)*COS(lat*PI()/180)*POW(SIN((#{1}*PI()/180-lng*PI()/180)/2),2)))*1000) AS juli
		FROM release_activity where city=#{2} and type=1 and typeok!=3 and typeok!=5 and typeok!=2  and typeok!=6
		ORDER BY juli 
		LIMIT 50
	</select>
	<select id="selectact" parameterType="map" resultMap="Activity">
		SELECT *, ROUND(6378.138*2*ASIN(SQRT(POW(SIN((#{0}*PI()/180-lat*PI()/180)/2),2)+COS(#{0}*PI()/180)*COS(lat*PI()/180)*POW(SIN((#{1}*PI()/180-lng*PI()/180)/2),2)))*1000) AS juli
		FROM release_activity where city=#{2} and type=1 and activitycategory=#{3} and typeok!=3 and typeok!=5 and typeok!=2  and typeok!=6
		ORDER BY juli 
		LIMIT 50
	</select>
</mapper>